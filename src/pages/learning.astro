---
import { IconFile, IconGripVertical, IconPlayerPlay } from "@tabler/icons-react"
import Section from "../components/shared/sections/Section.astro"
import NavButtons from "../features/content/components/NavButtons.astro"
import LayoutContent from "../layouts/LayoutContent.astro"
import { tutorial } from "../utils/lib/content.config"

const sortedTutorials = tutorial.sort((a, b) => (a.frontmatter.order ?? 0) - (b.frontmatter.order ?? 0))
---

<LayoutContent>
  <div
    id="main-container"
    class="flex flex-col lg:flex-row mx-2 max-h-[calc(100vh-75px)] mt-0"
  >
    <!-- Panel izquierdo: Contenido -->
    <Section
      id="left-pane"
      className="flex-1 bg-(--light-bg) border border-(--stroke-color)  rounded-2xl flex flex-col min-h-[250px] transition-all duration-150 "
    >
      <article class="scroll-container m-2 overflow-y-auto p-2">
        {
          sortedTutorials.map(t => (
            <article class="mb-6" id="content-markdown">
              <h2 class="text-xl font-bold mb-2">{t.frontmatter.title}</h2>
              <t.Content />
              <hr class="my-6 border-gray-700" />
            </article>
          ))
        }
      </article>
      <div class="flex justify-center p-3 mt-auto">
        <NavButtons />
      </div>
    </Section>

    <!-- Separador vertical (solo desktop) -->
    <div
      id="vertical-resizer"
      class="hidden lg:flex items-center justify-center w-3 hover:w-4 transition-all cursor-col-resize select-none"
    >
      <IconGripVertical size={14} />
    </div>

    <!-- Panel derecho: Editor + Terminal -->
    <Section
      id="right-pane"
      className="flex-1 bg-(--light-bg) border border-(--stroke-color) rounded-2xl flex flex-col min-h-[250px] transition-all duration-150"
    >
      <!-- Barra superior -->
      <div class="flex justify-between border-b border-stroke-color rounded-t-2xl p-2">
        <div class="flex gap-2">
          <button
            class="flex items-center gap-1.5 bg-neutral-500/40 px-2 py-1 rounded-md hover:bg-neutral-500/70 text-sm"
          >
            <IconFile size={18} /> C칩digo
          </button>
        </div>
        <button
          class="flex items-center gap-1.5 bg-neutral-500/40 px-2 py-1 rounded-md hover:bg-neutral-500/70 text-sm"
        >
          <IconPlayerPlay size={18} /> Ejecutar
        </button>
      </div>

      <!-- Contenido -->
      <div class="flex flex-col flex-1 overflow-hidden">
        <div id="editor" class="flex-1 min-h-[200px]"></div>

        <div
          id="horizontal-resizer"
          class="h-2 hover:h-4 transition-all cursor-row-resize bg-transparent"
        >
        </div>

        <div
          id="terminal"
          class="h-40 overflow-auto bg-editor-bg border-t border-stroke-color p-2 text-sm font-mono"
        >
          <span class="text-yellow">$ <span class="text-fg">cargo</span> run</span>
        </div>
      </div>
    </Section>
  </div>
</LayoutContent>

<script lang="ts" is:inline>
  const verticalResizer = document.getElementById('vertical-resizer')
  const leftPane = document.getElementById('left-pane')
  const rightPane = document.getElementById('right-pane')
  const horizontalResizer = document.getElementById('horizontal-resizer')
  const editor = document.getElementById('editor')
  const terminal = document.getElementById('terminal')

  // 游댳 Ajustar al cambio de tama침o de ventana (modo m칩vil/deskop)
  function resetLayoutOnResize() {
    if (window.innerWidth < 1024) {
      leftPane.style.width = ''
      rightPane.style.width = ''
      leftPane.style.flex = '1'
      rightPane.style.flex = '1'
    }
  }
  window.addEventListener('resize', resetLayoutOnResize)

  // 游댳 Separador vertical (desktop)
  verticalResizer?.addEventListener('mousedown', e => {
    if (window.innerWidth < 1024) return // no en m칩vil
    e.preventDefault()

    const startX = e.clientX
    const startLeftWidth = leftPane.offsetWidth
    const startRightWidth = rightPane.offsetWidth
    const minWidth = 250
    const maxWidth = window.innerWidth - minWidth

    function onMouseMove(ev) {
      const dx = ev.clientX - startX
      const newLeftWidth = Math.min(Math.max(startLeftWidth + dx, minWidth), maxWidth)
      const newRightWidth = window.innerWidth - newLeftWidth - 40 // margen del separador
      leftPane.style.flex = 'none'
      rightPane.style.flex = 'none'
      leftPane.style.width = newLeftWidth + 'px'
      rightPane.style.width = newRightWidth + 'px'
    }

    function onMouseUp() {
      window.removeEventListener('mousemove', onMouseMove)
      window.removeEventListener('mouseup', onMouseUp)
    }

    window.addEventListener('mousemove', onMouseMove)
    window.addEventListener('mouseup', onMouseUp)
  })

  // 游댳 Separador horizontal (editor / terminal)
  horizontalResizer?.addEventListener('mousedown', e => {
    e.preventDefault()

    const startY = e.clientY
    const startEditorHeight = editor.offsetHeight
    const startTerminalHeight = terminal.offsetHeight
    const minHeight = 100
    const maxHeight = 500

    function onMouseMove(ev) {
      const dy = ev.clientY - startY
      const newEditorHeight = Math.min(Math.max(startEditorHeight + dy, minHeight), maxHeight)
      const newTerminalHeight = Math.min(Math.max(startTerminalHeight - dy, minHeight), maxHeight)
      editor.style.height = newEditorHeight + 'px'
      terminal.style.height = newTerminalHeight + 'px'
    }

    function onMouseUp() {
      window.removeEventListener('mousemove', onMouseMove)
      window.removeEventListener('mouseup', onMouseUp)
    }

    window.addEventListener('mousemove', onMouseMove)
    window.addEventListener('mouseup', onMouseUp)
  })
</script>

<style scoped>
  .scroll-container {
    scrollbar-width: thin;
    scrollbar-color: var(--editor-bg) transparent;
  }

  .scroll-container::-webkit-scrollbar {
    width: 8px;
  }

  .scroll-container::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 8px;
  }

  .scroll-container::-webkit-scrollbar-thumb:hover {
    background-color: var(--editor-bg);
  }
</style>
